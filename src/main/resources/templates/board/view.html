<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>게시글 상세보기</title>
</head>
<body>
	<th:block th:include="common/header"></th:block>
	<div class="page-content">
		<div class="page-title">Q&A</div>
		
		<div class="btn-zone">
			<a th:href="@{/board/boardList?reqPage=1}" class="btn">목록으로</a>
			<!-- <th:block th:if="${session.member != null && (session.member.memberId == b.boardWriter || session.member.memberLevel == 1)}"> -->
			<th:block th:if="${session.member == null}">
				<a th:href="@{/board/updateFrm(boardNo=${b.boardNo})}" class="btn">수정</a>
				<button class="btn" th:onclick="boardDelete([[${b.boardNo}]]);">삭제</button>
			</th:block>
		</div>
		
		<table class="tbl boardView">
			<tr>
				<th colspan="6" th:text="${b.boardTitle}"></th>
			</tr>
			<tr>
				<td th:text="${b.boardWriter}"></td>
				<td th:text="${b.regDate}"></td>
				<th>첨부파일</th>
				<td>
					<th:block th:each="file : ${b.fileList}">
						<img src="/img/files.png" width="16px">
						<a th:href="@{/board/filedown(filename=${file.filename},filepath=${file.filepath})}" th:text="다운로드"></a>
					</th:block>
				</td>
				<th>조회수</th>
				<td th:text="${b.readCount}"></td>
			</tr>
			<tr>
				<td colspan="6">
					<div class="boardContent" th:utext="${b.boardContent}"></div>
				</td>
			</tr>
		</table>
		<!-- 댓글 공간 -->
		<div class="inputCommentBox" th:if="${session.member != null}">
			<form action="/board/insertComment" method="post">
				<ul>
					<li>
						<span class="material-icons">account_circle</span>
					</li>
					<li>
						<input type="hidden" name="CommentWriter" th:value="${session.member.memberNickname}">
						<input type="hidden" name="boardRef" th:value="${b.boardNo}">
						<input type="hidden" name="CommentRef" th:value=0>
						<textarea name="CommentContent" class="input-form"></textarea>
					</li>
					<li>
						<button type="submit" class="btn bc1 bs4">등록</button>
					</li>
				</ul>
			</form>
		</div>
		
		<div class="commentBox">
			<th:block th:each="bc : ${commentList}">
				<ul class="posting-comment">
					<li>
						<span class="material-icons">account_circle</span>
					</li>
					<li>
						<p class="comment-info">
							<span th:text="${bc.CommentWriter}"></span>
							<span th:text="${bc.CommentDate}"></span>
						</p>
						<p class="comment-content" th:utext="${bc.CommentContent.replace('\n','<br>')}" style="white-space: pre-line;"></p>
						<textarea name="CommentContent" class="input-form" th:text="${bc.CommentContent}" style="min-height:90px;display:none"></textarea>
						<p class="comment-link">
							<th:block th:if="${session.member != null}">
								<th:block th:if="${session.member.memberNickname == bc.boardCommentWriter || session.member.memberLevel == 1}">
									<a href="javascript:void(0)" th:onclick="modifyComment(this,[[${bc.CommentNo}]],[[${b.boardNo}]])">수정</a>
									<a href="javascript:void(0)" th:onclick="deleteComment(this,[[${bc.CommentNo}]],[[${b.boardNo}]])">삭제</a>
								</th:block>
								<a href="javascript:void(0)" class="recShow">답글달기</a>
							</th:block>
						</p>
					</li>
				</ul>
				
				<th:block th:each="bcc : ${reCommentList}">
					<ul class="posting-comment reply" th:if="${bc.CommentNo == bcc.CommentRef}">
						<li>
							<span class="material-icons">subdirectory_arrow_right</span>
							<span class="material-icons">account_circle</span>
						</li>
						<li>
							<p class="comment-info">
								<span th:text="${bcc.CommentWriter}"></span>
								<span th:text="${bcc.CommentDate}"></span>
							</p>
							<p class="comment-content" th:utext="${bcc.CommentContent.replace('\n','<br>')}" style="white-space: pre-line;"></p>
							<textarea name="CommentContent" class="input-form" th:text="${bcc.CommentContent}" style="min-height:90px;display:none"></textarea>
							<p class="comment-link">
								<th:block th:if="${session.member != null}">
									<th:block th:if="${session.member.memberNickname == bcc.CommentWriter || session.member.memberLevel == 1}">
										<a href="javascript:void(0)" th:onclick="modifyComment(this,[[${bcc.CommentNo}]],[[${b.boardNo}]])">수정</a>
										<a href="javascript:void(0)" th:onclick="deleteComment(this,[[${bcc.CommentNo}]],[[${b.boardNo}]])">삭제</a>
									</th:block>
								</th:block>
							</p>
						</li>
					</ul>
				</th:block>
				
				<div class="inputCommentBox inputRecommentBox" th:if="${session.member != null}">
					<form action="/board/insertComment" method="post">
						<ul>
							<li>
								<span class="material-icons">subdirectory_arrow_right</span>
							</li>
							<li>
								<input type="hidden" name="CommentWriter" th:value="${session.member.memberNickname}">
								<input type="hidden" name="boardRef" th:value="${b.boardNo}">
								<input type="hidden" name="CommentRef" th:value="${bc.CommentNo}">
								<textarea name="CommentContent" class="input-form"></textarea>
							</li>
							<li>
								<button type="submit" class="btn">등록</button>
							</li>
						</ul>
					</form>
				</div>
			</th:block>
		</div>
	</div>
	
	<script>
		function boardDelete(boardNo) {
			if(confirm("게시글을 삭제하시겠습니까?")) {
				location.href="/board/delete?boardNo="+boardNo;
			}
		}
		
		$(".recShow").on("click",function(){
			const index = $(".recShow").index(this);
			$(".inputRecommentBox").eq(index).toggle();
			if($(this).text() == "답글달기") {
				$(this).text("취소");
				$(".inputRecommentBox").eq(index).find("textarea").focus();
			} else {
				$(this).text("답글달기");
			}
			
		});
		
		function modifyComment(obj,commentNo,boardNo) {
			$(obj).parent().prev().show();
			$(obj).parent().prev().prev().hide();
			$(obj).text("수정완료");
			$(obj).attr("onclick","modifyComplete(this,"+commentNo+","+boardNo+")");
			$(obj).next().text("수정취소");
			$(obj).next().attr("onclick","modifyCancel(this,"+commentNo+","+boardNo+")");
			$(obj).next().next().hide();
		}
		function modifyCancel(obj,commentNo,boardNo) {
			$(obj).parent().prev().hide();
			$(obj).parent().prev().prev().show();
			$(obj).prev().text("수정");
			$(obj).prev().attr("onclick","modifyComment(this,"+commentNo+","+boardNo+")");
			$(obj).text("삭제");
			$(obj).attr("onclick","deleteComment(this,"+commentNo+","+boardNo+")");
			$(obj).next().show();
		}
		
		function modifyComplete(obj,commentNo,boardNo) {
			const form = $("<form style='display:none;' action='/board/updateComment' method='post'>");
			const boardCommentNoInput = $("<input type='text' name='commentNo'>");
			boardCommentNoInput.val(commentNo);
			const boardNoInput = $("<input type='text' name='boardRef'>");
			boardNoInput.val(boardNo);
			const boardCommentContent = $(obj).parent().prev().clone();
			form.append(boardCommentNoInput).append(boardNoInput).append(boardCommentContent);
			$("body").append(form);
			form.submit();
		}
		
		function deleteComment(obj,commentNo,boardNo) {
			if(confirm("댓글을 삭제하시겠습니까?")) {
				location.href="/board/deleteComment?boardCommentNo="+commentNo+"&boardNo="+boardNo;
			}
		}
	
	</script>
	<th:block th:include="common/footer"></th:block>
</body>
</html>